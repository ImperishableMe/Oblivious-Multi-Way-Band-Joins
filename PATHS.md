# Project Structure and Paths

## Project Root
`/home/r33wei/omwj/memory_const_public/`

This document describes the complete structure of the Memory-Constrained Oblivious Multi-Way Join project after reorganization.

## Documentation Files (Root Level)
- `README.md` - Project overview and quick start guide
- `PATHS.md` - This file - complete directory structure reference
- `CLAUDE.md` - AI assistant instructions and project context
- `Makefile` - Build system configuration

---

## Directory Structure Overview

### `/app/` - Host Application Code
Code that runs outside the SGX enclave on the regular host system. Uses C++ STL.

- **`algorithms/`** - Join algorithm implementations
  - `oblivious_join.cpp/h` - Main orchestrator combining all phases
  - `bottom_up_phase.cpp/h` - Compute local multiplicities going up the tree
  - `top_down_phase.cpp/h` - Propagate final multiplicities down the tree
  - `distribute_expand.cpp/h` - Oblivious tuple replication
  - `align_concat.cpp/h` - Oblivious alignment and concatenation

- **`batch/`** - Ecall batching system
  - `ecall_batch_collector.cpp/h` - Collects operations to reduce SGX transitions
  - `ecall_wrapper.cpp/h` - Wrapper for SGX ecalls with counting
  - Reduces overhead by bundling multiple operations into single ecalls

- **`core/`** - Core data structures
  - `entry.cpp/h` - Entry structure (row representation)
  - `table.cpp/h` - Table structure (collection of entries)
  - `types.h` - Type definitions used by host application

- **`crypto/`** - Encryption utilities
  - `crypto_utils.cpp/h` - AES encryption/decryption for data at rest
  - Handles encryption outside the enclave

- **`debug/`** - Debug utilities
  - `debug_util.cpp/h` - Debug logging functionality
  - `debug_manager.cpp/h` - Manages debug sessions and output

- **`io/`** - Input/Output operations
  - `table_io.cpp/h` - Read/write tables from/to files
  - `converters.cpp/h` - Convert between formats (CSV, encrypted)

- **`join/`** - Join framework components
  - `join_condition.cpp/h` - Join condition representation
  - `join_constraint.cpp/h` - Join constraint handling
  - `join_tree_node.h` - Join tree node structure
  - `join_tree_builder.cpp/h` - Builds join tree from conditions
  - `join_attribute_setter.cpp/h` - Manages join attribute extraction

- **`query/`** - SQL query processing
  - `query_parser.cpp/h` - Parse SQL SELECT statements
  - `query_tokenizer.cpp/h` - Tokenize SQL queries
  - `inequality_parser.cpp/h` - Parse inequality conditions
  - `condition_merger.cpp/h` - Merge multiple conditions

- **`utils/`** - Helper utilities
  - `counted_ecalls.h` - Track ecall counts for performance

### `/enclave/` - SGX Enclave Components

- **`trusted/`** - Code running INSIDE the secure SGX enclave
  - Has access to decrypted sensitive data
  - Protected from host OS and other processes
  - Written in C (no STL due to SGX constraints)
  - Files in root:
    - `Enclave.cpp` - Main enclave entry point
    - `Enclave.edl` - Enclave Definition Language interface
    - `Enclave.lds` - Linker script
    - `Enclave.config.xml` - Enclave configuration
    - `Enclave_private.pem` - Private key for signing
    - `debug_wrapper.c` - Debug support in enclave
    - `secure_key.h` - Secure key management
    - `enclave_types.h` - Type definitions for enclave
    - `core.h` - Core function declarations
    - `Enclave_t.c/h` - Generated trusted proxy (auto-generated)
  - **`crypto/`** - Cryptographic operations
    - `aes_crypto.c/h` - AES encryption/decryption
    - `crypto_helpers.c/h` - Helper functions for crypto
    - `entry_crypto.h` - Entry-specific crypto definitions
    - `aes_operations.c` - Additional AES operations
  - **`operations/`** - Core data operations
    - `comparators.c` - Comparison functions
    - `transform_functions.c` - Data transformation
    - `distribute_functions.c` - Distribution operations
    - `window_functions.c` - Window-based operations
  - **`batch/`** - Batch processing
    - `batch_dispatcher.c/h` - Dispatch batched operations
  - **`test/`** - Test ecalls
    - `test_ecalls.c` - Test ecall implementations
    - `test_crypto_ecalls.c` - Crypto test ecalls
  - **`core/`** - Legacy core operations (kept for compatibility)

- **`untrusted/`** - Bridge between host and enclave
  - Auto-generated by SGX edger8r tool
  - `Enclave_u.c/h` - Untrusted proxy functions (host side)
  - Marshals data across the enclave boundary

### `/common/` - Shared Headers
Headers and definitions shared between host and enclave code.

- `types_common.h` - Common type definitions
- `enclave_types.h` - Entry structure shared definition
- `batch_types.h` - Batch operation type definitions
- `constants.h` - System-wide constants
- `debug_util.h` - Debug utilities shared
- `debug_config.h` - Debug configuration

### `/main/` - Entry Point Programs

- **`sgx_join/`** - Main SGX join application
  - `main.cpp` - Entry point for sgx_app executable

### `/tests/` - Test Infrastructure

- **`baseline/`** - Reference implementation
  - `sqlite_baseline.cpp` - SQLite-based reference for correctness testing

- **`integration/`** - Integration tests
  - `test_join.cpp` - Compare SGX output with SQLite baseline

- **`performance/`** - Performance tests
  - Performance benchmarking tools

- **`unit/`** - Unit tests
  - Unit tests for individual components

### `/input/` - Input Data and Queries

- **`queries/`** - SQL test queries
  - `tpch_tb1.sql` - Two-table equality join
  - `tpch_tb2.sql` - Two-table inequality join
  - `tpch_tm1.sql` - Three-table join
  - `tpch_tm2.sql` - Three-table complex join
  - `tpch_tm3.sql` - Three-table chain join

- **`plaintext/`** - Unencrypted test data
  - `data_0_001/` - TPC-H scale 0.001 (~150 rows/table)
  - `data_0_01/` - TPC-H scale 0.01 (~1,500 rows/table)

- **`encrypted/`** - Encrypted test data
  - `data_0_001/` - Encrypted TPC-H scale 0.001
  - `data_0_01/` - Encrypted TPC-H scale 0.01

### `/output/` - Program Outputs
Directory for storing join results and debug outputs.

### `/scripts/` - Build and Test Scripts
- `build.sh` - Build script
- `test.sh` - Test runner
- `run_tpch_tests.sh` - Run all TPC-H tests
- `setup_env.sh` - Environment setup

---

## Build Instructions

All builds should be executed from the project root:

```bash
cd /home/r33wei/omwj/memory_const_public

# Build main application and enclave
make

# Build with debug output
DEBUG=1 make

# Build in slim entry mode (reduced memory)
make SLIM_ENTRY=1

# Build test programs
make tests

# Build specific test
make test_join
make sqlite_baseline

# Clean and rebuild
make clean && make
```

---

## Executable Locations

After building, executables are located in project root:

- `./sgx_app` - Main SGX join application
- `./enclave.signed.so` - Signed enclave library
- `./test_join` - Integration test tool
- `./sqlite_baseline` - SQLite reference implementation
- `./encrypt_tables` - Data encryption tool

---

## Usage Examples

### Running the SGX Join Application
```bash
# From project root
./sgx_app <query_file> <encrypted_data_dir> <output_file>

# Example
./sgx_app input/queries/tpch_tb1.sql input/encrypted/data_0_001 output.csv
```

### Running Integration Tests
```bash
# Compare SGX with SQLite baseline (2 arguments only)
./test_join <query_file> <encrypted_data_dir>

# Example
./test_join input/queries/tpch_tb1.sql input/encrypted/data_0_001
```

### Running SQLite Baseline
```bash
# Run SQLite reference (3 arguments)
./sqlite_baseline <query_file> <encrypted_data_dir> <output_file>

# Example
./sqlite_baseline input/queries/tpch_tb1.sql input/encrypted/data_0_001 baseline.csv
```

### Encrypting Data
```bash
# Encrypt plaintext CSV files
./encrypt_tables <plaintext_dir> <encrypted_output_dir>

# Example
./encrypt_tables input/plaintext/data_0_001 /tmp/encrypted_data
```

### Running Test Suites
```bash
# Run all TPC-H tests with default scale (0.001)
./scripts/run_tpch_tests.sh

# Run with specific scale
./scripts/run_tpch_tests.sh 0_01
```

---

## Key Concepts

### SGX Enclave Architecture
- **Trusted Code**: Runs inside the enclave with access to sensitive data
- **Untrusted Code**: Runs on regular host, orchestrates enclave operations
- **EDL Interface**: Defines the boundary between trusted and untrusted code
- **Ecalls**: Calls from untrusted to trusted code
- **Ocalls**: Calls from trusted to untrusted code (minimized for security)

### Data Flow
1. Encrypted data stored on disk
2. Host application reads encrypted data
3. Data sent to enclave via ecalls
4. Enclave decrypts and processes data
5. Results encrypted before leaving enclave
6. Host writes encrypted results to disk

### Security Properties
- Data never decrypted outside enclave
- Memory access patterns are data-oblivious
- Constant memory overhead regardless of data distribution
- Side-channel resistant through oblivious algorithms

---

## Important Notes

### Build Modes
- **Fat Entry Mode** (default): ~2256 bytes per entry
- **Slim Entry Mode**: ~260 bytes per entry (use `SLIM_ENTRY=1`)
- Modes are incompatible - data encrypted in one mode cannot be decrypted in the other

### Data Constraints
- All data must be integers
- Valid range: [-1,073,741,820, 1,073,741,820]
- NULL represented as INT32_MAX
- String data not supported (will parse as 0)

### Debug Output
- Debug output goes to files in `debug/` directory
- Enable with `DEBUG=1` during compilation
- Format: `debug/{date}_{time}_{test}/`